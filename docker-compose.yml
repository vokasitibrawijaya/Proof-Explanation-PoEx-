version: '3.8'

services:
  # Blockchain node (Hardhat local node)
  blockchain:
    build:
      context: ./hardhat
      dockerfile: Dockerfile
    container_name: fedxchain-blockchain
    ports:
      - "8545:8545"
    networks:
      - fedxchain-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8545"]
      interval: 10s
      timeout: 5s
      retries: 5
    volumes:
      - blockchain-data:/app/artifacts

  # Contract deployer
  deployer:
    build:
      context: ./hardhat
      dockerfile: Dockerfile
    container_name: fedxchain-deployer
    depends_on:
      blockchain:
        condition: service_healthy
    environment:
      - BLOCKCHAIN_RPC=http://blockchain:8545
    networks:
      - fedxchain-network
    volumes:
      - contract-data:/app/deployments
    command: >
      sh -c "npx hardhat run scripts/deploy.js --network localhost"

  # Aggregator server (coordinates FL rounds)
  aggregator:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: fedxchain-aggregator
    depends_on:
      deployer:
        condition: service_completed_successfully
    environment:
      - BLOCKCHAIN_RPC=http://blockchain:8545
      - NODE_TYPE=aggregator
      - N_CLIENTS=${N_CLIENTS:-5}
      - AGG_METHOD=${AGG_METHOD:-fedxchain}
      - MAX_ROUNDS=${MAX_ROUNDS:-10}
      - RUN_ID=${RUN_ID:-1}
      - CLEAR_RESULTS=${CLEAR_RESULTS:-0}
      - ATTACK_TYPE=${ATTACK_TYPE:-none}
      - MALICIOUS_RATIO=${MALICIOUS_RATIO:-0}
      - MALICIOUS_CLIENTS=${MALICIOUS_CLIENTS:-}
    ports:
      - "5000:5000"
    networks:
      - fedxchain-network
    volumes:
      - ./results:/app/results
      - ./logs:/app/logs
      - ./configs:/app/configs
      - contract-data:/app/deployments
    command: python scripts/run_distributed_aggregator.py

  # FL Client nodes
  client_0:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: fedxchain-client-0
    depends_on:
      - aggregator
    environment:
      - BLOCKCHAIN_RPC=http://blockchain:8545
      - NODE_TYPE=client
      - NODE_ID=0
      - AGGREGATOR_URL=http://aggregator:5000
      - LOCAL_EPOCHS=${LOCAL_EPOCHS:-1}
      - SHAP_SAMPLES=${SHAP_SAMPLES:-10}
      - SEED=${SEED:-42}
      - ATTACK_TYPE=${ATTACK_TYPE:-none}
      - ATTACK_SIGMA=${ATTACK_SIGMA:-0.1}
      - MALICIOUS_RATIO=${MALICIOUS_RATIO:-0}
      - MALICIOUS_CLIENTS=${MALICIOUS_CLIENTS:-}
      - MALICIOUS=${CLIENT_0_MALICIOUS:-0}
    networks:
      - fedxchain-network
    volumes:
      - ./configs:/app/configs
      - contract-data:/app/deployments
    command: python scripts/run_distributed_client.py

  client_1:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: fedxchain-client-1
    depends_on:
      - aggregator
    environment:
      - BLOCKCHAIN_RPC=http://blockchain:8545
      - NODE_TYPE=client
      - NODE_ID=1
      - AGGREGATOR_URL=http://aggregator:5000
      - LOCAL_EPOCHS=${LOCAL_EPOCHS:-1}
      - SHAP_SAMPLES=${SHAP_SAMPLES:-10}
      - SEED=${SEED:-42}
      - ATTACK_TYPE=${ATTACK_TYPE:-none}
      - ATTACK_SIGMA=${ATTACK_SIGMA:-0.1}
      - MALICIOUS_RATIO=${MALICIOUS_RATIO:-0}
      - MALICIOUS_CLIENTS=${MALICIOUS_CLIENTS:-}
      - MALICIOUS=${CLIENT_1_MALICIOUS:-0}
    networks:
      - fedxchain-network
    volumes:
      - ./configs:/app/configs
      - contract-data:/app/deployments
    command: python scripts/run_distributed_client.py

  client_2:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: fedxchain-client-2
    depends_on:
      - aggregator
    environment:
      - BLOCKCHAIN_RPC=http://blockchain:8545
      - NODE_TYPE=client
      - NODE_ID=2
      - AGGREGATOR_URL=http://aggregator:5000
      - LOCAL_EPOCHS=${LOCAL_EPOCHS:-1}
      - SHAP_SAMPLES=${SHAP_SAMPLES:-10}
      - SEED=${SEED:-42}
      - ATTACK_TYPE=${ATTACK_TYPE:-none}
      - ATTACK_SIGMA=${ATTACK_SIGMA:-0.1}
      - MALICIOUS_RATIO=${MALICIOUS_RATIO:-0}
      - MALICIOUS_CLIENTS=${MALICIOUS_CLIENTS:-}
      - MALICIOUS=${CLIENT_2_MALICIOUS:-0}
    networks:
      - fedxchain-network
    volumes:
      - ./configs:/app/configs
      - contract-data:/app/deployments
    command: python scripts/run_distributed_client.py

  client_3:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: fedxchain-client-3
    depends_on:
      - aggregator
    environment:
      - BLOCKCHAIN_RPC=http://blockchain:8545
      - NODE_TYPE=client
      - NODE_ID=3
      - AGGREGATOR_URL=http://aggregator:5000
      - LOCAL_EPOCHS=${LOCAL_EPOCHS:-1}
      - SHAP_SAMPLES=${SHAP_SAMPLES:-10}
      - SEED=${SEED:-42}
      - ATTACK_TYPE=${ATTACK_TYPE:-none}
      - ATTACK_SIGMA=${ATTACK_SIGMA:-0.1}
      - MALICIOUS_RATIO=${MALICIOUS_RATIO:-0}
      - MALICIOUS_CLIENTS=${MALICIOUS_CLIENTS:-}
      - MALICIOUS=${CLIENT_3_MALICIOUS:-0}
    networks:
      - fedxchain-network
    volumes:
      - ./configs:/app/configs
      - contract-data:/app/deployments
    command: python scripts/run_distributed_client.py

  client_4:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: fedxchain-client-4
    depends_on:
      - aggregator
    environment:
      - BLOCKCHAIN_RPC=http://blockchain:8545
      - NODE_TYPE=client
      - NODE_ID=4
      - AGGREGATOR_URL=http://aggregator:5000
      - LOCAL_EPOCHS=${LOCAL_EPOCHS:-1}
      - SHAP_SAMPLES=${SHAP_SAMPLES:-10}
      - SEED=${SEED:-42}
      - ATTACK_TYPE=${ATTACK_TYPE:-none}
      - ATTACK_SIGMA=${ATTACK_SIGMA:-0.1}
      - MALICIOUS_RATIO=${MALICIOUS_RATIO:-0}
      - MALICIOUS_CLIENTS=${MALICIOUS_CLIENTS:-}
      - MALICIOUS=${CLIENT_4_MALICIOUS:-0}
    networks:
      - fedxchain-network
    volumes:
      - ./configs:/app/configs
      - contract-data:/app/deployments
    command: python scripts/run_distributed_client.py

networks:
  fedxchain-network:
    driver: bridge

volumes:
  blockchain-data:
  contract-data:
